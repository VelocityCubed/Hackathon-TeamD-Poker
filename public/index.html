<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1v1 Poker Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/cards.css">
    <link rel="stylesheet" href="/pixel-theme.css">
    <script src="/cardRenderer.js"></script>
</head>
<body class="min-h-screen flex items-center justify-center pixel-body">
    <div class="container mx-auto p-4 max-w-6xl">
        <h1 class="pixel-title text-4xl font-bold text-center mb-8">♠ TEXAS POKER ♥</h1>
        
        <div id="game-container" class="hidden">
            <!-- Bot Section -->
            <div class="pixel-box pixel-box-red rounded-lg p-6 mb-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <img src="/assets/bot-portrait.png" alt="Bot" class="pixel-portrait w-20 h-20 rounded-full object-cover">
                        <div>
                            <h2 class="text-2xl font-bold text-white pixel-text">BOT</h2>
                            <p class="text-yellow-300 text-xl flex items-center gap-2 pixel-text">
                                <span>$<span id="bot-chips">1000</span></span>
                            </p>
                            <p class="text-blue-300 flex items-center gap-2 pixel-text">
                                <span>BET: <span id="bot-bet">0</span></span>
                            </p>
                        </div>
                        <div id="bot-chip-visual" class="flex items-center gap-1">
                            <!-- Chip visualization will be shown here -->
                        </div>
                    </div>
                    <div id="bot-hand" class="card-hand">
                        <!-- Bot cards will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Community Cards and Pot -->
            <div class="poker-table-area relative rounded-lg p-8 mb-4 overflow-hidden">
                <!-- Overlay to darken background slightly for better text readability -->
                <div class="absolute inset-0 bg-black bg-opacity-30 rounded-lg"></div>
                
                <div class="relative z-10 text-center mb-4">
                    <h3 class="text-xl font-bold text-white mb-2 pixel-text">COMMUNITY CARDS</h3>
                    <div id="community-cards" class="community-cards">
                        <!-- Community cards will be shown here -->
                    </div>
                    <div class="pixel-pot-box text-center rounded-lg py-3 px-6 inline-block">
                        <p class="text-yellow-300 text-2xl font-bold flex items-center justify-center gap-3 pixel-text">
                            <span>POT: $<span id="pot">0</span></span>
                            <span id="pot-chip-visual" class="flex items-center gap-1">
                                <!-- Pot chip visualization -->
                            </span>
                        </p>
                        <p class="text-gray-200 text-lg mt-2 pixel-text">PHASE: <span id="phase">-</span></p>
                    </div>
                </div>
            </div>

            <!-- Player Section -->
            <div class="pixel-box pixel-box-blue rounded-lg p-6 mb-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <img src="/assets/player-portrait.png" alt="Player" class="pixel-portrait w-20 h-20 rounded-full object-cover">
                        <div>
                            <h2 class="text-2xl font-bold text-white pixel-text">YOU</h2>
                            <p class="text-yellow-300 text-xl flex items-center gap-2 pixel-text">
                                <span>$<span id="player-chips">1000</span></span>
                            </p>
                            <p class="text-blue-300 flex items-center gap-2 pixel-text">
                                <span>BET: <span id="player-bet">0</span></span>
                            </p>
                        </div>
                        <div id="player-chip-visual" class="flex items-center gap-1">
                            <!-- Chip visualization will be shown here -->
                        </div>
                    </div>
                    <div id="player-hand" class="card-hand">
                        <!-- Player cards will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="pixel-box rounded-lg p-6">
                <div id="action-buttons" class="flex flex-wrap gap-3 justify-center">
                    <button id="fold-btn" class="pixel-btn pixel-btn-red font-bold py-3 px-6 rounded-lg transition">
                        FOLD
                    </button>
                    <button id="check-btn" class="pixel-btn pixel-btn-blue font-bold py-3 px-6 rounded-lg transition">
                        CHECK
                    </button>
                    <button id="call-btn" class="pixel-btn pixel-btn-green font-bold py-3 px-6 rounded-lg transition">
                        CALL
                    </button>
                    <div class="flex gap-2 items-center">
                        <input id="raise-amount" type="number" min="10" step="10" value="20" 
                               class="pixel-input px-4 py-3 rounded-lg w-32" title="Raise amount">
                        <button id="raise-btn" class="pixel-btn pixel-btn-purple font-bold py-3 px-6 rounded-lg transition">
                            RAISE
                        </button>
                    </div>
                </div>
                <div id="message" class="mt-4 text-center text-white text-lg font-semibold pixel-text"></div>
            </div>
        </div>

        <!-- Start/New Game Button -->
        <div id="start-container" class="text-center">
            <button id="new-game-btn" class="pixel-btn pixel-btn-yellow font-bold py-4 px-8 rounded-lg text-2xl transition shadow-lg">
                START GAME
            </button>
        </div>

        <!-- Winner Modal -->
        <div id="winner-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
            <div class="pixel-modal rounded-xl p-10 max-w-lg mx-4 text-center transform scale-100 transition-all">
                <h2 class="text-4xl font-bold text-white mb-2 pixel-text">★ ROUND OVER ★</h2>
                <div class="bg-yellow-400 h-1 w-32 mx-auto mb-6 rounded-full"></div>
                <p id="winner-message" class="text-2xl text-yellow-300 mb-8 font-semibold leading-relaxed pixel-text"></p>
                <div class="flex gap-4 justify-center flex-wrap">
                    <button id="next-round-btn" class="pixel-btn pixel-btn-green font-bold py-4 px-8 rounded-lg transition-all shadow-lg hover:shadow-xl hover:scale-105 transform">
                        ► NEXT ROUND
                    </button>
                    <button id="reset-game-btn" class="pixel-btn pixel-btn-red font-bold py-4 px-8 rounded-lg transition-all shadow-lg hover:shadow-xl hover:scale-105 transform">
                        ◄ RESET GAME
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameState = null;
        let pollInterval = null;

        const cardSymbols = {
            hearts: '♥️',
            diamonds: '♦️',
            clubs: '♣️',
            spades: '♠️'
        };

        // Function to create chip visualization based on chip count
        function createChipVisualization(chipCount) {
            const chipImages = [];
            
            // Determine which chip images to show based on amount
            if (chipCount >= 500) {
                // Large amount - show variant stack
                chipImages.push({ src: '/assets/chips-stack-variant1.png', alt: 'Large chip stack' });
            } else if (chipCount >= 200) {
                // Medium-high amount - show gold stack
                chipImages.push({ src: '/assets/chip-stack-gold.png', alt: 'Gold chip stack' });
            } else if (chipCount >= 100) {
                // Medium amount - show teal stack
                chipImages.push({ src: '/assets/chip-stack-teal.png', alt: 'Teal chip stack' });
            } else if (chipCount >= 50) {
                // Small-medium amount - show red stack
                chipImages.push({ src: '/assets/chip-stack-red.png', alt: 'Red chip stack' });
            } else if (chipCount >= 20) {
                // Small amount - show single chips
                chipImages.push({ src: '/assets/chip-gold.png', alt: 'Gold chip' });
            } else if (chipCount > 0) {
                // Very small amount - show red chip
                chipImages.push({ src: '/assets/chip-red.png', alt: 'Red chip' });
            }
            
            return chipImages;
        }

        // Function to update chip visualization in the UI
        function updateChipDisplay(elementId, chipCount) {
            const container = document.getElementById(elementId);
            if (!container) return;
            
            container.innerHTML = '';
            const chipImages = createChipVisualization(chipCount);
            
            chipImages.forEach(chip => {
                const img = document.createElement('img');
                img.src = chip.src;
                img.alt = chip.alt;
                img.className = 'w-12 h-12 object-contain';
                container.appendChild(img);
            });
        }

        function createCardElement(card, hidden = false) {
            // Use the new sprite-based card renderer
            if (hidden) {
                return window.CardRenderer.createCardElement(null, true, 'md', false);
            } else {
                return window.CardRenderer.createCardElement(card, false, 'md', false);
            }
        }

        function updateUI(data) {
            const game = data.game;
            gameState = game;
            
            const player = game.players.find(p => p.id === 'player');
            const bot = game.players.find(p => p.id === 'bot');
            
            // Update player info
            document.getElementById('player-chips').textContent = player.chips;
            document.getElementById('player-bet').textContent = player.currentBet;
            document.getElementById('bot-chips').textContent = bot.chips;
            document.getElementById('bot-bet').textContent = bot.currentBet;
            document.getElementById('pot').textContent = game.pot;
            document.getElementById('phase').textContent = game.phase;
            
            // Update chip visualizations
            updateChipDisplay('player-chip-visual', player.chips);
            updateChipDisplay('bot-chip-visual', bot.chips);
            updateChipDisplay('pot-chip-visual', game.pot);
            
            // Update player hand
            const playerHandDiv = document.getElementById('player-hand');
            playerHandDiv.innerHTML = '';
            player.hand.forEach(card => {
                playerHandDiv.appendChild(createCardElement(card));
            });
            
            // Update bot hand
            const botHandDiv = document.getElementById('bot-hand');
            botHandDiv.innerHTML = '';
            if (bot.hand && bot.hand.length > 0) {
                bot.hand.forEach(card => {
                    botHandDiv.appendChild(createCardElement(card));
                });
            } else {
                // Show hidden cards
                [1, 2].forEach(() => {
                    botHandDiv.appendChild(createCardElement(null, true));
                });
            }
            
            // Update community cards
            const communityDiv = document.getElementById('community-cards');
            communityDiv.innerHTML = '';
            game.communityCards.forEach(card => {
                communityDiv.appendChild(createCardElement(card));
            });
            
            // Update buttons
            updateButtons(game, player);
            
            // Check for winner
            if (data.winner) {
                showWinner(data.winner);
            }
        }

        function updateButtons(game, player) {
            const maxBet = Math.max(...game.players.map(p => p.currentBet));
            const callAmount = maxBet - player.currentBet;
            const isPlayerTurn = game.currentPlayerIndex === 0;
            
            document.getElementById('fold-btn').disabled = !isPlayerTurn || player.folded;
            document.getElementById('check-btn').disabled = !isPlayerTurn || callAmount > 0;
            document.getElementById('call-btn').disabled = !isPlayerTurn || callAmount === 0;
            document.getElementById('raise-btn').disabled = !isPlayerTurn || player.chips <= 0;
            const raiseInput = document.getElementById('raise-amount');
            if (raiseInput) {
                raiseInput.disabled = !isPlayerTurn || player.chips <= 0;
                const maxRaise = Math.max(player.chips, 0);
                if (maxRaise > 0) {
                    raiseInput.max = maxRaise;
                }
                if (parseInt(raiseInput.value, 10) > maxRaise) {
                    raiseInput.value = String(maxRaise);
                }
            }
            
            if (callAmount > 0) {
                document.getElementById('call-btn').textContent = `Call ${callAmount}`;
            } else {
                document.getElementById('call-btn').textContent = 'Call';
            }
            
            const message = document.getElementById('message');
            if (!isPlayerTurn && !player.folded && game.phase !== 'showdown') {
                message.textContent = 'Bot is thinking...';
            } else if (isPlayerTurn) {
                message.textContent = 'Your turn!';
            } else {
                message.textContent = '';
            }
        }

        function showWinner(winner) {
            const winnerModal = document.getElementById('winner-modal');
            const winnerMessage = document.getElementById('winner-message');
            const gameContainer = document.getElementById('game-container');
            const actionButtons = document.getElementById('action-buttons');
            
            // Disable all game buttons
            actionButtons.querySelectorAll('button, input').forEach(el => el.disabled = true);
            
            // Add blur effect to game container
            gameContainer.style.filter = 'blur(3px)';
            gameContainer.style.pointerEvents = 'none';
            
            if (winner.winnerId === 'player') {
                winnerMessage.innerHTML = `🎉 You won <strong>${winner.winAmount} chips</strong> with <strong>${winner.hand}</strong>! 🎉`;
            } else {
                winnerMessage.innerHTML = `Bot won <strong>${winner.winAmount} chips</strong> with <strong>${winner.hand}</strong>.`;
            }
            
            // Show modal with animation
            winnerModal.classList.remove('hidden');
            setTimeout(() => {
                winnerModal.querySelector('div').style.transform = 'scale(1.05)';
                setTimeout(() => {
                    winnerModal.querySelector('div').style.transform = 'scale(1)';
                }, 200);
            }, 10);
            
            if (pollInterval) {
                clearInterval(pollInterval);
            }
        }

        function hideWinnerModal() {
            const winnerModal = document.getElementById('winner-modal');
            const gameContainer = document.getElementById('game-container');
            
            // Remove blur effect
            gameContainer.style.filter = 'none';
            gameContainer.style.pointerEvents = 'auto';
            
            // Hide modal
            winnerModal.classList.add('hidden');
        }

        async function startNewGame() {
            try {
                const response = await fetch('/api/game/new', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('game-container').classList.remove('hidden');
                    document.getElementById('game-container').style.filter = 'none';
                    document.getElementById('game-container').style.pointerEvents = 'auto';
                    document.getElementById('start-container').classList.add('hidden');
                    hideWinnerModal();
                    updateUI(data);
                    startPolling();
                }
            } catch (error) {
                console.error('Error starting game:', error);
            }
        }

        async function startNextRound() {
            try {
                const response = await fetch('/api/game/next-round', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    hideWinnerModal();
                    updateUI(data);
                    startPolling();
                } else if (data.gameOver) {
                    // One player is out of chips - show final game over
                    const winnerMessage = document.getElementById('winner-message');
                    winnerMessage.innerHTML = `<strong>${data.error}</strong><br>Game Over! 🏁`;
                    document.getElementById('next-round-btn').style.display = 'none';
                    document.getElementById('reset-game-btn').textContent = '🎮 New Game';
                }
            } catch (error) {
                console.error('Error starting next round:', error);
            }
        }

        async function resetGame() {
            try {
                await fetch('/api/game/reset', { method: 'POST' });
            } catch (error) {
                console.error('Error resetting game:', error);
            }

            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }

            gameState = null;
            hideWinnerModal();

            const gameContainer = document.getElementById('game-container');
            gameContainer.classList.add('hidden');
            gameContainer.style.filter = 'none';
            gameContainer.style.pointerEvents = 'auto';
            document.getElementById('start-container').classList.remove('hidden');

            document.getElementById('player-hand').innerHTML = '';
            document.getElementById('bot-hand').innerHTML = '';
            document.getElementById('community-cards').innerHTML = '';
            document.getElementById('player-chips').textContent = '1000';
            document.getElementById('bot-chips').textContent = '1000';
            document.getElementById('player-bet').textContent = '0';
            document.getElementById('bot-bet').textContent = '0';
            document.getElementById('pot').textContent = '0';
            document.getElementById('phase').textContent = '-';
            updateChipDisplay('player-chip-visual', 1000);
            updateChipDisplay('bot-chip-visual', 1000);
            updateChipDisplay('pot-chip-visual', 0);
            document.getElementById('message').textContent = '';

            const raiseInput = document.getElementById('raise-amount');
            if (raiseInput) {
                raiseInput.disabled = false;
                raiseInput.value = '20';
            }

            document.getElementById('next-round-btn').style.display = 'inline-block';
            document.getElementById('reset-game-btn').textContent = '🔄 Reset Game';
        }

        async function performAction(action, amount) {
            try {
                const response = await fetch('/api/game/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, amount })
                });
                
                const data = await response.json();
                if (data.success) {
                    updateUI(data);
                }
            } catch (error) {
                console.error('Error performing action:', error);
            }
        }

        async function checkGameState() {
            try {
                const response = await fetch('/api/game/check');
                const data = await response.json();
                
                if (data.success) {
                    updateUI(data);
                }
            } catch (error) {
                console.error('Error checking game state:', error);
            }
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(checkGameState, 1000);
        }

        // Event listeners
        document.getElementById('new-game-btn').addEventListener('click', startNewGame);
        document.getElementById('next-round-btn').addEventListener('click', startNextRound);
        document.getElementById('reset-game-btn').addEventListener('click', resetGame);
        
        document.getElementById('fold-btn').addEventListener('click', () => performAction('fold'));
        document.getElementById('check-btn').addEventListener('click', () => performAction('check'));
        document.getElementById('call-btn').addEventListener('click', () => performAction('call'));
        document.getElementById('raise-btn').addEventListener('click', () => {
            const raiseInput = document.getElementById('raise-amount');
            if (!raiseInput) return;
            const rawAmount = parseInt(raiseInput.value, 10);
            if (!gameState) return;
            const player = gameState.players.find(p => p.id === 'player');
            if (!player) return;
            const maxRaise = Math.max(player.chips, 0);
            const amount = Math.min(Math.max(rawAmount || 0, 0), maxRaise);
            if (amount <= 0) {
                return;
            }
            const maxBet = Math.max(...gameState.players.map(p => p.currentBet));
            const callAmount = Math.max(maxBet - player.currentBet, 0);
            if (amount <= callAmount) {
                const messageEl = document.getElementById('message');
                if (messageEl) {
                    messageEl.textContent = `Raise must exceed the call amount of ${callAmount}.`;
                }
                return;
            }
            performAction('bet', amount);
        });
    </script>
</body>
</html>
